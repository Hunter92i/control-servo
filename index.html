<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arduino Servo Controller</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding: 20px; font-family: 'Segoe UI', sans-serif; }
        .card { margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .card-header { font-weight: bold; background-color: #fff; border-bottom: 1px solid #eee; }
        .log-window { height: 150px; overflow-y: auto; background: #fdfdfd; border: 1px solid #ddd; padding: 10px; font-family: monospace; font-size: 0.9em; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container" style="max-width: 800px;">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Arduino Servo Controller</h2>
        <select id="productMode" class="form-select w-auto" onchange="toggleMotorMode()">
            <option value="1">Product A (1 Motor)</option>
            <option value="2">Product B (2 Motors)</option>
        </select>
    </div>

    <div class="card">
        <div class="card-header">Connection Settings</div>
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-auto"><label class="form-label fw-bold">Port:</label></div>
                <div class="col-auto">
                    <select id="portSelect" class="form-select" style="min-width: 250px;">
                        <option value="">Scan...</option>
                    </select>
                </div>
                <div class="col-auto">
                    <button class="btn btn-outline-secondary" onclick="scanPorts()" title="Refresh">
                        &#x21bb;
                    </button>
                </div>
                <div class="col-auto">
                    <button class="btn btn-outline-dark" onclick="connectArduino()">Connect</button>
                </div>
                <div class="col">
                    <span id="connectionStatus" class="fw-bold text-danger">Not connected</span>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Manual Control</div>
        <div class="card-body">
            
            <div id="motorSelectorDiv" class="mb-3 hidden">
                <label class="form-label fw-bold">Select Motor:</label>
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="motorSelect" id="m1" value="1" checked>
                    <label class="btn btn-outline-primary" for="m1">Motor 1</label>

                    <input type="radio" class="btn-check" name="motorSelect" id="m2" value="2">
                    <label class="btn btn-outline-primary" for="m2">Motor 2</label>

                    <input type="radio" class="btn-check" name="motorSelect" id="m3" value="3">
                    <label class="btn btn-outline-primary" for="m3">Both (Sync)</label>
                </div>
            </div>

            <div class="row align-items-center">
                <div class="col-auto"><label class="form-label fw-bold">Target angle (0–180°):</label></div>
                <div class="col">
                    <input type="number" id="targetAngle" class="form-control" value="0" min="0" max="180">
                </div>
                <div class="col-auto">
                    <button class="btn btn-light border" onclick="setAngleManual()">Set angle</button>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Scan Parameters</div>
        <div class="card-body">
            <div class="mb-3 row">
                <label class="col-sm-4 col-form-label fw-bold">Step size (deg/step):</label>
                <div class="col-sm-3"><input type="number" id="stepSize" class="form-control" value="5"></div>
                <div class="col-sm-auto"><button class="btn btn-light border btn-sm mt-1">Set step</button></div>
            </div>
            <div class="row">
                <label class="col-sm-4 col-form-label fw-bold">Time between steps (ms):</label>
                <div class="col-sm-3"><input type="number" id="stepTime" class="form-control" value="500"></div>
                <div class="col-sm-auto"><button class="btn btn-light border btn-sm mt-1">Set interval</button></div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body d-flex gap-2 flex-wrap">
            <button class="btn btn-outline-success" onclick="startScan()">Run</button>
            <button class="btn btn-outline-danger" onclick="stopScan()">Stop</button>
            <button class="btn btn-outline-secondary" onclick="stepOnce()">Step once</button>
            <button class="btn btn-outline-secondary" onclick="resetZero()">Reset to 0°</button>
            <button class="btn btn-light border" onclick="log('Status refreshed')">Refresh state</button>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="fw-bold">Current angle: <span id="currentAngleDisplay">0</span>°</div>
            <div class="fw-bold">State: <span id="stateDisplay">IDLE</span></div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Log</div>
        <div class="card-body p-0">
            <div id="logArea" class="log-window"></div>
        </div>
    </div>

</div>

<script>
    const API_URL = "http://127.0.0.1:5000";
    let currentAngle = 0;
    let scanInterval = null;
    let isConnected = false;

    window.onload = function() {
        scanPorts();
    };

    // --- 1. GESTION DES PORTS (Nouveau) ---
    async function scanPorts() {
        const select = document.getElementById('portSelect');
        select.innerHTML = '<option>Scanning...</option>';
        
        try {
            const res = await fetch(`${API_URL}/scan-ports`);
            const ports = await res.json(); // Reçoit maintenant [{device: "COM3", description: "Arduino..."}, ...]
            
            select.innerHTML = ''; 
            
            if (ports.length === 0) {
                select.add(new Option("Aucun port trouvé", ""));
            } else {
                ports.forEach(p => {
                    // On affiche la description (ex: "Arduino Uno (COM3)")
                    // Mais on envoie la valeur technique (ex: "COM3")
                    const opt = document.createElement('option');
                    opt.value = p.device;
                    opt.text = p.description; 
                    select.add(opt);
                });
            }
            log(`Ports trouvés: ${ports.length}`);
        } catch (e) {
            log("Erreur scan ports: " + e);
            select.innerHTML = '<option>Erreur API</option>';
        }
    }

    async function connectArduino() {
        const portSelect = document.getElementById('portSelect');
        const selectedPort = portSelect.value;

        if (!selectedPort) {
            alert("Sélectionnez un port valide !");
            return;
        }

        try {
            log(`Connexion à ${selectedPort}...`);
            const res = await fetch(`${API_URL}/connect`, { 
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ port: selectedPort }) 
            });
            const data = await res.json();
            
            if (data.connected) {
                isConnected = true;
                // Affiche juste "Connected" ou "Connected (COM3)"
                document.getElementById('connectionStatus').innerText = `Connected (${data.port})`;
                document.getElementById('connectionStatus').className = "fw-bold text-success";
                log("Succès : Arduino connecté.");
            } else {
                log("Echec connexion : " + data.error);
                alert("Impossible de se connecter.");
            }
        } catch (e) {
            log("Erreur serveur : " + e);
        }
    }

    // --- 2. GESTION PRODUITS (Bug corrigé) ---
    function toggleMotorMode() {
        const mode = document.getElementById('productMode').value;
        const selector = document.getElementById('motorSelectorDiv');
        
        if (mode === "2") {
            selector.classList.remove('hidden');
            log("Mode activé : Produit B (2 Moteurs)");
        } else {
            selector.classList.add('hidden');
            document.getElementById('m1').checked = true; // Retour moteur 1 par défaut
            log("Mode activé : Produit A (1 Moteur)");
        }
    }

    function getSelectedMotor() {
        const radios = document.getElementsByName('motorSelect');
        for (let r of radios) {
            if (r.checked) return parseInt(r.value);
        }
        return 1;
    }

    // --- 3. COMMANDES ---
    async function sendMove(angle) {
        if (!isConnected) { log("Erreur: Non connecté"); return; }
        
        const motorId = getSelectedMotor();
        try {
            await fetch(`${API_URL}/move`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ motor_id: motorId, angle: angle })
            });
            currentAngle = angle;
            document.getElementById('currentAngleDisplay').innerText = currentAngle;
        } catch (e) { log("Erreur envoi: " + e); }
    }

    function setAngleManual() {
        const angle = parseInt(document.getElementById('targetAngle').value);
        log(`Action: Set ${angle}°`);
        sendMove(angle);
    }

    function resetZero() {
        stopScan();
        log("Action: Reset 0°");
        document.getElementById('targetAngle').value = 0;
        sendMove(0);
    }

    function stepOnce() {
        const step = parseInt(document.getElementById('stepSize').value);
        let next = currentAngle + step;
        if (next > 180) next = 0;
        sendMove(next);
    }

    function startScan() {
        if (scanInterval) return;
        const timeMs = parseInt(document.getElementById('stepTime').value);
        const step = parseInt(document.getElementById('stepSize').value);
        
        log("Scan démarré...");
        document.getElementById('stateDisplay').innerText = "RUNNING";
        
        scanInterval = setInterval(() => {
            let next = currentAngle + step;
            if (next > 180) { next = 0; log("Scan: boucle"); }
            sendMove(next);
        }, timeMs);
    }

    function stopScan() {
        if (scanInterval) {
            clearInterval(scanInterval);
            scanInterval = null;
            document.getElementById('stateDisplay').innerText = "IDLE";
            log("Scan stoppé.");
        }
    }

    function log(msg) {
        const d = new Date();
        const time = d.getHours() + ":" + d.getMinutes() + ":" + d.getSeconds();
        const logArea = document.getElementById('logArea');
        logArea.innerHTML += `<div><small>[${time}]</small> ${msg}</div>`;
        logArea.scrollTop = logArea.scrollHeight;
    }
</script>

</body>
</html>
